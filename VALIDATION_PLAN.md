# 验证方案：标准测试用例集（变更场景模板）

> 目标：验证“影响分析可信 + 闸门合理 + 证据可回放”。  
> 输出：可执行测试用例、记录结构化证据、用于试点验收。

---

## 1) 使用方法
1. 每个变更场景填写模板（下文表格）。  
2. 执行变更前后的对比查询与影响分析。  
3. 记录结果与证据链接。  

---

## 2) 变更场景模板

### 用例模板（每个场景填写一次）
- **用例ID**：
- **变更类型**：逻辑定义 / 版本 / 字段映射 / 实体关系 / 粒度规则  
- **变更内容**（简述）：  
- **预期影响范围**（指标/实体/维度/属性/SQL映射）：  
- **预期风险等级**（L1/L2/L3）：
- **影响分析结果**（impact/diff）：  
- **Evidence SQL**：  
- **样例查询集（Before/After）**：  
- **是否通过**：是 / 否  
- **备注**：

---

## 3) 标准场景集合（建议 12–16 个）

### A. 逻辑定义变更（5 个）
1. **FPY 逻辑改动**：`good_qty / total_qty` → `good_qty / (total_qty + 1)`  
2. **QualityScore 公式权重调整**：`0.7/0.3` → `0.6/0.4`  
3. **DefectRate 公式变更**：分子修改  
4. **变量替换**：`rework_qty` → `rework_qty_adjusted`  
5. **删除变量引用**：移除某指标引用

### B. 版本变更（3 个）
6. **新增版本**：新增 `FPY_v3_newline`  
7. **切换版本优先级**：提升某版本优先级  
8. **版本失效**：设置 effective_to

### C. 字段映射变更（2 个）
9. **物理映射 SQL 变更**：字段名替换  
10. **参数 schema 变更**：新增 required 参数

### D. 实体/关系变更（2 个）
11. **实体关系改动**：`ProductionLine → ProductionRecord` 关系替换  
12. **新增维度**：`plant` 维度加入实体

### E. 粒度与维度规则（2–4 个）
13. **非法粒度**：请求粒度比 metric_grain 更细  
14. **非法维度**：请求包含 forbidden_dimensions  
15. **维度不在 allowed**  
16. **跨域维度请求**

---

## 4) 验证检查点（每个用例必须覆盖）
- DAG 是否自动更新
- Impact 是否命中预期影响范围
- Evidence 是否可回放（可执行 SQL/审计ID）
- GrainValidator 是否合理拦截或给出建议
- 变更失败是否 fail-closed

---

## 5) 输出归档格式（建议）
- `case_id.json`：记录 diff/impact/证据/结果  
- `case_id.md`：可阅读报告
